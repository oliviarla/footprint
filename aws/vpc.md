# VPC

## CIDR

* 클래스 없는 도메인 간 라우팅
* IP 주소를 할당하는 방법이다.
* 서브넷을 통해 IP 주소의 범위를 표현할 수 있다.
* `<BaseIP>/<Subnet Mask>` 과 같이 정의된다.
  * BaseIP
    * 범위에 포함되는 IP
    * 32 bit로 표현되며, 8 bit로 쪼개 옥텟이라는 단위로 부른다.
  * Subnet Mask
    * IP 주소 중 변경이 가능한 비트 수를 정의한다.
    * `/0`, `/24`, `/32`  처럼 표현할 수 있으며, 이는 32 bit 중 몇 개의 비트가 고정되어 있는지를 표현한다.
    * `/0` : 변경 가능한 비트 수가 32개이다. 따라서 모든 IP를 의미한다.
    * `/24` : 변경 가능한 비트 수가 (32 - 24 = 8)개이므로 (2^8 = 256)개씩 IP를 쪼갰을 때 BaseIP가 존재하는 범위를 의미한다. 예를 들어 192.168.0.0/24 는 192.168.0.0 \~ 192.168.0.255의 범위를 나타내게 된다.
    * `/26` : 변경 가능한 비트 수가 (32 - 26 = 6)개이므로 (2^6 = 64)개씩 IP를 쪼갰을 때 BaseIP가 존재하는 범위를 의미한다. 예를 들어 192.168.0.0/26 는 192.168.0.0 \~ 192.168.0.63의 범위를 나타내게 된다.
    * `/16` : 변경 가능한 비트 수가 (32 - 16 = 16)개이므로 (2^12 = 65536)개씩 IP를 쪼갰을 때 BaseIP가 존재하는 범위를 의미한다. 예를 들어 192.168.0.0/16 는 192.168.0.0 \~ 192.168.255.255의 범위를 나타내게 된다.
    * `/32` : 변경 가능한 비트 수가 없다. 따라서 하나의 BaseIP를 의미하게 된다.
* Public vs Private
  * 사설 IP 대역
    * `10.0.0.0/8`
      * 10.0.0.0 \~ 10.255.255.255
    * `172.16.0.0/12`
      * 172.16.0.0 \~ 172.31.255.255
      * AWS 기본 VPC 대역
    * `192.168.0.0/16`
      * 192.168.0.0 \~ 192.168.255.255
  * 이외의 대부분 IP는 공인 IP 대역에 해당한다.&#x20;

## VPC

* Virtual Private Cloud
* AWS 클라우드에 있는 사설 네트워크
* AWS 리소스를 배포하는 곳이다.
* 리전마다 하나씩 존재하며 최대 5개까지 만들 수 있으나 더 늘릴 수도 있다.
* 새로운 AWS 계정을 생성하면 기본 VPC가 배정된다. 새로운 EC2 인스턴스 생성 시 서브넷을 따로 지정하지 않으면 기본 VPC에 생성되고 인터넷에 연결 가능하며 공인 IP를 갖게 된다. 또한 public, private IPv4 DNS 이름을 갖게 된다.

### CIDRs

* VPC에서 허용하는 IP 범위(CIDR 범위)를 가질 수 있다. 최대 5개의 범위를 지정할 수 있다.
* CIDR의 최소 크기는 `/28`이고, 최대 크기는 `/16`이다.
* VPC 자체가 private이므로, 사설 IP 대역이 할당된다.
* **다른 VPC나 네트워크와 겹치지 않게 IP 범위를 설정**해야 한다.

### 서브넷

> public subnet: 공용 서브넷
>
> private subnet: 사설 서브넷

* VPC 내부에는 네트워크를 분할하기 위한 서브넷이 있다. 서브넷은 AZ 리소스이다.
* 공용 서브넷은 인터넷으로부터 접근 가능하다.
* 사설 서브넷은 인터넷에서 접근할 수 없다. 사설 서브넷에 있는 EC2 인스턴스 역시 인터넷에 접근할 수 없다.
* VPC 내에서 여러 라우팅 테이블을 정의하여 인터넷으로의 접근과 서브넷 사이의 접근을 정의한다.

<figure><img src="../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

## 게이트웨이

### 인터넷 게이트웨이

* VPC의 리소스를 인터넷에 연결하도록 허용하는 EC2 인스턴스나 람다 함수 등을 의미한다.
* 공용 서브넷은 인터넷 게이트웨이로 라우팅된다.
* 수평으로 확장되고 고가용성을 보장하는 관리형 리소스이다.
* VPC와는 별개로 생성해야 하고 VPC는 인터넷 Gateway 하나에만 연결된다.
* 라우팅 테이블을 수정해 리소스가 라우터를 통해 인터넷 게이트웨이와 연결되도록 해주어야 비로소 인터넷 연결이 가능해진다.

### NAT 게이트웨이

* 사설 서브넷의 리소스로부터 인터넷에 접근하게 하고, 인터넷에서 사설 서브넷에는 접근하지 못하게 하기 위해 사용된다.
* AWS에서 관리하기 때문에 프로비저닝과 스케일링 관련해서 신경 쓸 필요가 없다.
* NAT 게이트웨이를 공용 서브넷에 배포하고, 사설 서브넷에서 NAT 게이트웨이로 라우팅한다. 공용 서브넷에 있던 NAT 게이트웨이는 인터넷 게이트웨이를 통해 라우팅되어 인터넷에 접근 가능하게 된다.
* 특정 AZ에 Elastic IP를 통해 생성된다.
* 같은 서브넷 상의 EC2 인스턴스를 사용할 수 없다. 따라서 다른 서브넷에서 접근할 때에만 NAT 게이트웨이가 유용하다.
* 초당 5Gbps 대역폭을 제공하며 자동으로 45Gbps까지 확장 가능하다.
* 보안 그룹을 관리할 필요가 없다.
* 다중 AZ에서 각각 NAT 게이트웨이를 배포해두면 fault tolerance를 보장할 수 있다.
*   한 AZ가 중지되면 해당 AZ의 NAT 게이트웨이와 EC2 인스턴스 모두 정상적인 상태가 아니게 되므로, 라우팅 테이블로 AZ를 서로 연결하는 cross-AZ failover는 필요 없다.

    <figure><img src="../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>
* 서브넷 대역 중 5개의 IP (첫 4개, 마지막 1개)는 예약된 IP 주소이다.
  * 예를 들어 10.0.0.0/24 CIDR 블록을 지정했다면, 다음 주소들은 사용할 수 없다.
    * 10.0.0.0: 네트워크 주소
    * 10.0.0.1: AWS VPC router에 사용되는 주소
    * 10.0.0.2: Amazon-provided DNS에 매핑되는 주소
    * 10.0.0.3: 나중에 AWS에서 사용하기 위한 예비용 주소
    * 10.0.0.255: 네트워크 브로드캐스트 주소, AWS는 VPC 내에서 브로드캐스팅을 허용하지 않으므로 실제로 사용할 수는 없다.
* 29개의 IP 주소를 필요로 하는 경우 서브넷을 `/27` 로 두면 실제로 사용 가능한 주소는 (2^5 - 5 = 27)개 이므로 부족하다. 따라서 서브넷을 `/26`으로 두어야 한다.

### NAT Instance

* NAT 게이트웨이와 달리 자체적으로 관리할 수 있는 NAT 인스턴스도 있다. 하지만 점차 지원하지 않을 예정이다.

<figure><img src="../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

* 사설 서브넷에 있는 EC2 인스턴스가 인터넷으로 연결할 수 있도록 해준다.
* 공용 서브넷에 고유의 보안 그룹이 있는 NAT 인스턴스를 실행하고, 탄력적 IP를 연결한다.
* 라우팅 테이블을 수정하여 사설 서브넷과 공용 서브넷의 두 서브넷에 있는 EC2 인스턴스로부터 NAT 인스턴스로 트래픽을 전송하도록 한다.
* 사설 서브넷에 위치한 인스턴스의 IP는 NAT 인스턴스를 통과하면서 감춰진다. 즉, 실제 외부로 트래픽이 나갈 때에는 공용 서브넷의 NAT 인스턴스 IP가 출발지 주소가 된다.
* 외부 인터넷으로부터 NAT 인스턴스에게 응답이 오면 사설 EC2 인스턴스로 트래픽을 포워딩한다. (이 때의 동작 방식은 Bastion Host와 동일하다.)
* NAT EC2 인스턴스는 소스 및 목적지 확인 설정을 비활성화해야 한다. NAT 인스턴스가 소스 및 목적지가 아니더라도 트래픽을 허용해야 하기 때문이다.
* 가용성이 높지 않고 초기화 설정으로 복원할 수 없어서 여러 AZ에 ASG를 생성해야 하고, 복원되는 사용자 데이터 스크립트가 필요하기에 복잡하다.
* 대역폭은 EC2 사양에 따라 달라진다.
* 보안 그룹과 규칙을 관리해주어야 한다.
  * 인바운드에서는, 사설 서브넷의 HTTP/HTTPS 트래픽을 허용하고 홈 네트워크의 SSH도 허용해야 한다.
  * 아웃바운드에서는 HTTP/HTTPS 트래픽을 허용해야 한다.

## Bastion Host

* **외부 인터넷으로부터 사설 서브넷에 접근하기 위해 사용되는 공용 서브넷에 있는 EC2 인스턴스**이다.
* 배스천 호스트로 사설 서브넷에 있는 EC2 인스턴스에 접근할 수 있다.
* 외부 사용자는 배스천 호스트에 SSH 연결하고, 배스천 호스트를 통해 사설 서브넷의 EC2 인스턴스에 연결하는 형태로 접근할 수 있다.
* 배스천 호스트 보안 그룹이라는 자체 보안 그룹이 있다. 보안 그룹에서는 인터넷으로부터의 SSH 접근을 허용해야 한다. 이 때 특정 공인 CIDR 범위에 대해서만 22번 포트를 허용해야 보안 상 안전하다.
* 사설 서브넷의 EC2 인스턴스 보안 그룹에서는 반드시 SSH 액세스를 허용해야 한다. 배스천 호스트의 사설 IP나 배스천 호스트의 보안 그룹만이 22번 포트에 접근할 수 있도록 해야 한다.

## 네트워크 보안

### 공용 서브넷 방어

* NACL
  * Network ACL
  * 방화벽과 같이 서브넷을 오고 가는 트래픽을 제어한다.
  * 허용 규칙과 거부 규칙을 통해 트래픽을 명시적으로 허용/거부할 수 있다.
  * 서브넷 수준에서 동작한다. 따라서 연결된 서브넷의 모든 EC2 인스턴스에 적용된다.
  * 규칙은 IP 주소를 대상으로 한다. 따라서 특정 IP 주소를 거부할 수 있다.
  * 기본 VPC가 있으면 **기본 NACL이 모든 트래픽의 인입을 허용**한다.
  * 보안 그룹과 달리 상태를 유지하지 않는다. 따라서 인바운드, 아웃바운드 규칙을 각각 설정해주어야 한다.
  * NACL 규칙
    * 1 \~ 32766 까지 우선 순위를 정할 수 있다. 100씩 증가시키면서 규칙을 정의하는 것을 권장한다.
    * 여러 규칙 중 가장 우선순위가 높아 처음 매칭되는 규칙을 적용한다.
    * 가장 마지막 규칙은 `*` 이고, 규칙에 매칭되지 않는 트래픽을 차단하도록 한다.
  * 새롭게 생성된 NACL은 기본적으로 모든 트래픽을 차단한다.
  * 임시 포트
    * 서버가 서비스를 제공할 때 클라이언트는 규정된 포트에 접속한다. 서버가 클라이언트에게 응답을 하려면 클라이언트에 연결해야 하는데, 클라이언트는 기본적으로 개방된 포트가 없다.
    * 따라서, 클라이언트가 서버에 접속 시 자체적으로 특정한 포트를 개방한다. 이 포트는 임시라서 클라이언트와 서버 간 연결이 유지되는 동안만 열려 있다.
    * 운영 체제에 따라 임시 포트 범위가 달라진다.
      * Windows 10: 49152 \~ 65,535
      * Linux: 32768 \~ 60999
    * 예를 들어 웹 계층 서브넷들에 매핑되는 웹 NACL과 DB 계층 서브넷들에 매핑되는 DB NACL가 있을 때 웹이 데이터베이스에 요청을 보낸 후 데이터베이스가 다시 웹으로 응답을 보낼 때, 웹 NACL의 인바운드는 DB 서브넷 CIDR의 임시 포트 범위의 TCP 트래픽을 허용해야 한다.
  * 다중 NACL 및 서브넷이 있다면 각 NACL의 조합이 NACL 내에서 허용되어야 한다. NACL에 서브넷을 추가하면 NACL 규칙도 업데이트해서 연결 조합이 유효한지 확인해야 한다.
* 보안 그룹
  * ENI라는 탄력적 네트워크 인터페이스 또는 EC2 인스턴스를 오고 가는 트래픽을 제어한다.
  * 허용 규칙만 존재한다.
  * 모든 규칙이 평가되고 난 후 트래픽 허용 여부를 결정한다.
  * IP 주소들이나 다른 보안 그룹들만 참조할 수 있다.
  * 인스턴스나 ENI에 연결된다.
  * 상태를 유지한다. 트래픽이 외부에서 시작해서 인바운드로 허용된다면, 아웃바운드 역시 허용되어 반환 트래픽이 전달된다.



이제 VPC와 네트워크 ACL 그리고 보안 그룹을 통해

트래픽의 흐름이 갖춰졌으니

모든 트래픽의 흐름에 관한 정보를 얻을 수 있는지 궁금합니다

이에 관한 로그를 얻을 수 있을까요

이는 VPC Flow Logs(VPC 흐름 로그)라고 합니다

이는 여러분의 인터페이스로 가는 모든 IP 트래픽의 정보를 획득하는데

이는 VPC 흐름 로그와 서브넷 흐름 로그 그리고 ENI 흐름 로그

또는 탄력적 네트워크 인터페이스 흐름 로그를 포함합니다

그러므로 네트워크가 VPC를 통해 지나간다면

흐름 로그에 로깅될 것이며

이는 모니터링하고 연결성 문제를 해결하는데 도움이 됩니다

예를 들어 여러분의 서브넷이 인터넷에 연결할 수 없는 이유를 알고 싶거나

인터넷이나 서브넷이 다른 서브넷과 통신할 수 있거나 못 하는 이유 등 말입니다

그러므로 네트워크 문제가 있고 이를 해결해야 한다면

VPC 흐름 로그를 보면 되는데 여기에 모든 것, 즉

허용 트래픽과 거부 트래픽에 대한 모든 정보가 있기 때문입니다

AWS에서 관리하는 모든 것에서 네트워크 정보 또한 획득하는데

Elastic Load Balancer, ElastiCache, RDS, Aurora등이 모두 VPC 흐름에 나타납니다

그러므로 연결성 문제가 있다면 바로 이 곳을 보시면 됩니다

그리고 VPC 흐름 로그 데이터는 Amazon S3와 CloudWatch Logs에 보낼 수 있고

Kinesis Data Firehose에서 볼 수 있으며 즉 AWS의 많은 곳에 보낼 수 있습니다





## VPC 피어링

* 내부적으로 여러 VPC들을 AWS network를 이용해 하나의 VPC처럼 사용할 수 있게 연결할 수 있다.
* 즉, 여러 VPC를 묶어 같은 네트워크에 있는 것처럼 동작하게 할 수 있다. 서로 다른 VPC에 연결이 가능하게 되는 것이다.
* **VPC 간에 할당된 CIDR 범위가 겹치면 통신이 불가능**하므로 안된다.
* 통신하려는 각 VPC에 모두 VPC 피어링이 활성화되어 있어야 한다. **A, B, C 세 개의 VPC가 있고 A와 B, B와 C가 연결되어 있더라도, A와 C가 통신하도록 하려면 각각 VPC 피어링 연결을 활성화해야 한다.**
* 서로 다른 VPC의 EC2 인스턴스가 서로 통신할 수 있도록 각 VPC 서브넷의 모든 라우팅 테이블을 업데이트해야 한다.
* 서로 다른 AWS 계정이나 리전 사이의 VPC들을 피어링할 수 있다.
* 보안 그룹에서 다른 보안 그룹을 참조할 수 있다. 동일한 지역의 계정 전체에서 피어링된 VPC의 보안 그룹을 참조하는 것도 가능하다.
* 소스를 CIDR 또는 IP로 가질 필요가 없다. AWS 계정 혹은 보안 그룹을 소스로 사용할 수 있다.

## VPC 엔드포인트



## VPC Flow 로그



## 사이트 간 VPN



Virtual Private Gateway



&#x20;고객 Gateway





## 다이렉트 커넥트





